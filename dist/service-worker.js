const APP_CACHE="app-shell-v2",DATA_CACHE="data-cache-v1",BASE=self.registration.scope.replace(location.origin,"").replace(/\/$/,"")+"/",APP_SHELL=[`${BASE}`,`${BASE}index.html`,`${BASE}bundle.js`,`${BASE}styles/style.css`,`${BASE}manifest.webmanifest`,`${BASE}icons/icon-192.png`,`${BASE}icons/icon-512.png`,`${BASE}icons/badge-72.png`];function idbOpen(){return new Promise((e,t)=>{const n=indexedDB.open("app-db",1);n.onupgradeneeded=()=>{const e=n.result;e.objectStoreNames.contains("items")||e.createObjectStore("items",{keyPath:"id"}),e.objectStoreNames.contains("pending")||e.createObjectStore("pending",{keyPath:"tempId"}),e.objectStoreNames.contains("auth")||e.createObjectStore("auth",{keyPath:"key"})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}async function idbGetAll(e){const t=await idbOpen();return new Promise((n,i)=>{const a=t.transaction(e,"readonly").objectStore(e).getAll();a.onsuccess=()=>n(a.result),a.onerror=()=>i(a.error)})}async function idbDelete(e,t){const n=await idbOpen();return new Promise((i,a)=>{const o=n.transaction(e,"readwrite");o.objectStore(e).delete(t),o.oncomplete=()=>i(),o.onerror=()=>a(o.error)})}async function syncPending(){const e=await idbGetAll("pending");if(!e.length)return;const[t]=await idbGetAll("auth"),n=t?.value||"";for(const t of e)try{if(!(await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${n}`},body:t.formData})).ok)continue;await idbDelete("pending",t.tempId),self.registration.showNotification("Sinkronisasi Berhasil",{body:t.description||"Cerita tersimpan."})}catch{}}self.addEventListener("install",e=>{e.waitUntil(caches.open(APP_CACHE).then(e=>e.addAll(APP_SHELL.map(e=>new Request(e,{cache:"reload"}))))),self.skipWaiting()}),self.addEventListener("activate",e=>{e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(![APP_CACHE,DATA_CACHE].includes(e))return caches.delete(e)})))),self.clients.claim()}),self.addEventListener("fetch",e=>{const t=e.request,n=new URL(t.url);"GET"===t.method&&("localhost"===n.hostname&&(n.pathname.includes("hot-update")||n.pathname.startsWith("/ws")||n.pathname.endsWith("/sockjs-node"))||("navigate"!==t.mode?n.origin===location.origin&&APP_SHELL.includes(n.pathname)||"story-api.dicoding.dev"!==n.hostname?e.respondWith(caches.match(t).then(e=>e||fetch(t))):e.respondWith((async()=>{try{const e=await fetch(t);return(await caches.open(DATA_CACHE)).put(t,e.clone()),e}catch{return await caches.match(t)||new Response(JSON.stringify({offline:!0,listStory:[]}),{headers:{"Content-Type":"application/json"}})}})()):e.respondWith(caches.match(`${BASE}index.html`).then(e=>e||fetch(`${BASE}index.html`)))))}),self.addEventListener("push",e=>{e.waitUntil((async()=>{if("undefined"!=typeof Notification&&"granted"!==Notification.permission)return;let t="Story Well",n="Ada cerita baru. Lihat detailnya!",i="./icons/icon-192.png",a="/#/",o="story";if(e.data)try{const s=e.data.json();t=s.title??t,n=s.body??n,i=s.icon??i,a=s.url??a,o=s.id?`story-${s.id}`:o}catch{n=await e.data.text()}return self.registration.showNotification(t,{body:n,icon:i,badge:"./icons/badge-72.png",tag:o,data:{url:a},actions:[{action:"open",title:"Buka"},{action:"dismiss",title:"Tutup"}]})})())}),self.addEventListener("notificationclick",e=>{if(e.notification.close(),"dismiss"===e.action)return;const t=e.notification.data?.url||"/#/";e.waitUntil((async()=>{const e=await clients.matchAll({type:"window",includeUncontrolled:!0});for(const n of e){try{n.navigate&&n.navigate(t)}catch{}if("focus"in n)return n.focus()}return clients.openWindow(t)})())}),self.addEventListener("sync",e=>{"sync-pending"===e.tag&&e.waitUntil(syncPending())});