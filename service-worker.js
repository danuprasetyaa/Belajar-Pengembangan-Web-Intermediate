const APP_CACHE="app-shell-v4",DATA_CACHE="data-cache-v1",BASE=self.registration.scope.replace(location.origin,"").replace(/\/$/,"")+"/",APP_SHELL=[`${BASE}`,`${BASE}index.html`,`${BASE}bundle.js`,`${BASE}styles/style.css`,`${BASE}manifest.webmanifest`,`${BASE}icons/icon-192.png`,`${BASE}icons/icon-512.png`,`${BASE}icons/badge-72.png`];async function syncPending(){const t=await idbGetAll("pending");if(!t.length)return;const[e]=await idbGetAll("auth"),n=e?.value||"";for(const e of t)try{if(!(await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${n}`},body:e.formData})).ok)continue;await idbDelete("pending",e.tempId),self.registration.showNotification("Sinkronisasi Berhasil",{body:e.description||"Cerita tersimpan."})}catch{}}function idbOpen(){return new Promise((t,e)=>{const n=indexedDB.open("app-db",1);n.onupgradeneeded=()=>{const t=n.result;t.objectStoreNames.contains("items")||t.createObjectStore("items",{keyPath:"id"}),t.objectStoreNames.contains("pending")||t.createObjectStore("pending",{keyPath:"tempId"}),t.objectStoreNames.contains("auth")||t.createObjectStore("auth",{keyPath:"key"})},n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)})}async function idbGetAll(t){const e=await idbOpen();return new Promise((n,i)=>{const a=e.transaction(t,"readonly").objectStore(t).getAll();a.onsuccess=()=>n(a.result),a.onerror=()=>i(a.error)})}async function idbDelete(t,e){const n=await idbOpen();return new Promise((i,a)=>{const o=n.transaction(t,"readwrite");o.objectStore(t).delete(e),o.oncomplete=()=>i(),o.onerror=()=>a(o.error)})}self.addEventListener("install",t=>{t.waitUntil((async()=>{const t=await caches.open(APP_CACHE);for(const e of APP_SHELL)try{await t.add(new Request(e,{cache:"reload"})),console.log("✅ Cached:",e)}catch(t){console.warn("⚠️ Gagal cache:",e,t)}})()),self.skipWaiting()}),self.addEventListener("activate",t=>{t.waitUntil(caches.keys().then(t=>Promise.all(t.map(t=>{if(![APP_CACHE,DATA_CACHE].includes(t))return caches.delete(t)})))),self.clients.claim()}),self.addEventListener("fetch",t=>{const e=t.request,n=new URL(e.url);"GET"===e.method&&("ws:"===n.protocol||"wss:"===n.protocol||"localhost"===n.hostname&&(n.pathname.includes("hot-update")||n.pathname.startsWith("/ws")||n.pathname.endsWith("/sockjs-node"))||("navigate"!==e.mode?"story-api.dicoding.dev"!==n.hostname?n.origin===location.origin&&t.respondWith(caches.match(e).then(t=>t||fetch(e).then(t=>{const n=t.clone();return caches.open(APP_CACHE).then(t=>t.put(e,n)),t}).catch(()=>{if("document"===e.destination)return caches.match(`${BASE}index.html`)}))):t.respondWith((async()=>{try{const t=await fetch(e);return(await caches.open(DATA_CACHE)).put(e,t.clone()),t}catch{return await caches.match(e)||new Response(JSON.stringify({offline:!0,listStory:[]}),{headers:{"Content-Type":"application/json"}})}})()):t.respondWith(caches.match(`${BASE}index.html`).then(t=>t||fetch(`${BASE}index.html`)))))}),self.addEventListener("push",t=>{t.waitUntil((async()=>{if("undefined"!=typeof Notification&&"granted"!==Notification.permission)return;let e="Story Well",n="Ada cerita baru!",i=`${BASE}icons/icon-192.png`,a=`${BASE}#/`,o="story";if(t.data)try{const s=t.data.json();e=s.title??e,n=s.body??n,i=s.icon??i,a=s.url??a,o=s.id?`story-${s.id}`:o}catch{n=await t.data.text()}return self.registration.showNotification(e,{body:n,icon:i,badge:`${BASE}icons/badge-72.png`,tag:o,data:{url:a},actions:[{action:"open",title:"Buka"},{action:"dismiss",title:"Tutup"}]})})())}),self.addEventListener("notificationclick",t=>{if(t.notification.close(),"dismiss"===t.action)return;const e=t.notification.data?.url||`${BASE}#/`;t.waitUntil((async()=>{const t=await clients.matchAll({type:"window",includeUncontrolled:!0});for(const n of t){try{n.navigate&&n.navigate(e)}catch{}if("focus"in n)return n.focus()}return clients.openWindow(e)})())}),self.addEventListener("sync",t=>{"sync-pending"===t.tag&&t.waitUntil(syncPending())});