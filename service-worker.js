const APP_CACHE="app-shell-v6",DATA_CACHE="data-cache-v2",BASE=self.registration.scope.replace(location.origin,"").replace(/\/$/,"")+"/",APP_SHELL=[`${BASE}`,`${BASE}index.html`,`${BASE}bundle.js`,`${BASE}styles/style.css`,`${BASE}manifest.webmanifest`,`${BASE}icons/icon-192.png`,`${BASE}icons/icon-512.png`,`${BASE}icons/badge-72.png`];async function syncPending(){const e=await idbGetAll("pending");if(!e.length)return;const[t]=await idbGetAll("auth"),n=t?.value||"";for(const t of e)try{if(!(await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${n}`},body:t.formData})).ok)continue;await idbDelete("pending",t.tempId),self.registration.showNotification("Sinkronisasi Berhasil",{body:t.description||"Cerita tersimpan."})}catch{}}function idbOpen(){return new Promise((e,t)=>{const n=indexedDB.open("app-db",1);n.onupgradeneeded=()=>{const e=n.result;e.objectStoreNames.contains("items")||e.createObjectStore("items",{keyPath:"id"}),e.objectStoreNames.contains("pending")||e.createObjectStore("pending",{keyPath:"tempId"}),e.objectStoreNames.contains("auth")||e.createObjectStore("auth",{keyPath:"key"})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}async function idbGetAll(e){const t=await idbOpen();return new Promise((n,i)=>{const a=t.transaction(e,"readonly").objectStore(e).getAll();a.onsuccess=()=>n(a.result),a.onerror=()=>i(a.error)})}async function idbDelete(e,t){const n=await idbOpen();return new Promise((i,a)=>{const o=n.transaction(e,"readwrite");o.objectStore(e).delete(t),o.oncomplete=()=>i(),o.onerror=()=>a(o.error)})}self.addEventListener("install",e=>{e.waitUntil((async()=>{const e=await caches.open(APP_CACHE);for(const t of APP_SHELL)try{await e.add(new Request(t,{cache:"reload"})),console.log("âœ… Cached:",t)}catch(e){console.warn("âš ï¸ Gagal cache:",t,e)}})()),self.skipWaiting()}),self.addEventListener("activate",e=>{e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(![APP_CACHE,DATA_CACHE].includes(e))return console.log("ðŸ—‘ï¸ Hapus cache lama:",e),caches.delete(e)})))),self.clients.claim()}),self.addEventListener("fetch",e=>{const t=e.request,n=new URL(t.url);"GET"===t.method&&(n.protocol.startsWith("ws")||n.pathname.includes("hot-update")||n.pathname.endsWith("/sockjs-node")||("navigate"!==t.mode?"story-api.dicoding.dev"!==n.hostname?n.origin===location.origin&&e.respondWith(caches.match(t).then(e=>e||fetch(t).then(e=>{const n=e.clone();return caches.open(APP_CACHE).then(e=>e.put(t,n)),e}).catch(()=>{if("document"===t.destination)return caches.match(`${BASE}index.html`)}))):e.respondWith((async()=>{try{const e=await fetch(t);return(await caches.open(DATA_CACHE)).put(t,e.clone()),e}catch{return await caches.match(t)||new Response(JSON.stringify({offline:!0,listStory:[]}),{headers:{"Content-Type":"application/json"}})}})()):e.respondWith(caches.match(`${BASE}index.html`).then(e=>e||fetch(`${BASE}index.html`)).catch(()=>caches.match(`${BASE}index.html`)))))}),self.addEventListener("push",e=>{e.waitUntil((async()=>{if("undefined"==typeof Notification)return;const t=Notification.permission;if("granted"!==t)return void console.warn("[SW] Izin notifikasi belum diberikan:",t);let n="Story Well",i="Ada cerita baru!",a=`${BASE}icons/icon-192.png`,o=`${BASE}#/`,c="story";if(e.data)try{const t=e.data.json();n=t.title??n,i=t.body??i,a=t.icon??a,o=t.url??o,c=t.id?`story-${t.id}`:c}catch{i=await e.data.text()}return self.registration.showNotification(n,{body:i,icon:a,badge:`${BASE}icons/badge-72.png`,tag:c,data:{url:o},actions:[{action:"open",title:"Buka"},{action:"dismiss",title:"Tutup"}]})})())}),self.addEventListener("notificationclick",e=>{if(e.notification.close(),"dismiss"===e.action)return;const t=e.notification.data?.url||`${BASE}#/`;e.waitUntil((async()=>{const e=await clients.matchAll({type:"window",includeUncontrolled:!0});for(const n of e)if("focus"in n)return n.focus(),void n.navigate(t);return clients.openWindow(t)})())}),self.addEventListener("sync",e=>{"sync-pending"===e.tag&&e.waitUntil(syncPending())});