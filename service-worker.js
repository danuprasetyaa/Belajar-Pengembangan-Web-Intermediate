const APP_CACHE="app-shell-v4",DATA_CACHE="data-cache-v1",BASE=self.registration.scope.replace(location.origin,"").replace(/\/$/,"")+"/",APP_SHELL=[`${BASE}`,`${BASE}index.html`,`${BASE}bundle.js`,`${BASE}styles/style.css`,`${BASE}manifest.webmanifest`,`${BASE}icons/icon-192.png`,`${BASE}icons/icon-512.png`,`${BASE}icons/badge-72.png`];async function syncPending(){const e=await idbGetAll("pending");if(!e.length)return;const[t]=await idbGetAll("auth"),n=t?.value||"";for(const t of e)try{if(!(await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${n}`},body:t.formData})).ok)continue;await idbDelete("pending",t.tempId),self.registration.showNotification("Sinkronisasi Berhasil",{body:t.description||"Cerita tersimpan."})}catch{}}function idbOpen(){return new Promise((e,t)=>{const n=indexedDB.open("app-db",1);n.onupgradeneeded=()=>{const e=n.result;e.objectStoreNames.contains("items")||e.createObjectStore("items",{keyPath:"id"}),e.objectStoreNames.contains("pending")||e.createObjectStore("pending",{keyPath:"tempId"}),e.objectStoreNames.contains("auth")||e.createObjectStore("auth",{keyPath:"key"})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}async function idbGetAll(e){const t=await idbOpen();return new Promise((n,i)=>{const o=t.transaction(e,"readonly").objectStore(e).getAll();o.onsuccess=()=>n(o.result),o.onerror=()=>i(o.error)})}async function idbDelete(e,t){const n=await idbOpen();return new Promise((i,o)=>{const a=n.transaction(e,"readwrite");a.objectStore(e).delete(t),a.oncomplete=()=>i(),a.onerror=()=>o(a.error)})}self.addEventListener("install",e=>{e.waitUntil((async()=>{const e=await caches.open(APP_CACHE);for(const t of APP_SHELL)try{await e.add(new Request(t,{cache:"reload"})),console.log("✅ Cached:",t)}catch(e){console.warn("⚠️ Gagal cache:",t,e)}})()),self.skipWaiting()}),self.addEventListener("activate",e=>{e.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(![APP_CACHE,DATA_CACHE].includes(e))return caches.delete(e)})))),self.clients.claim()}),self.addEventListener("fetch",e=>{const t=e.request,n=new URL(t.url);"GET"===t.method&&("ws:"===n.protocol||"wss:"===n.protocol||"localhost"===n.hostname&&(n.pathname.includes("hot-update")||n.pathname.startsWith("/ws")||n.pathname.endsWith("/sockjs-node"))||("navigate"!==t.mode?"story-api.dicoding.dev"!==n.hostname?n.origin===location.origin&&e.respondWith(caches.match(t).then(e=>e||fetch(t).then(e=>{const n=e.clone();return caches.open(APP_CACHE).then(e=>e.put(t,n)),e}).catch(()=>{if("document"===t.destination)return caches.match(`${BASE}index.html`)}))):e.respondWith((async()=>{try{const e=await fetch(t);return(await caches.open(DATA_CACHE)).put(t,e.clone()),e}catch{return await caches.match(t)||new Response(JSON.stringify({offline:!0,listStory:[]}),{headers:{"Content-Type":"application/json"}})}})()):e.respondWith(caches.match(`${BASE}index.html`).then(e=>e||fetch(`${BASE}index.html`)))))}),self.addEventListener("push",e=>{e.waitUntil((async()=>{if("undefined"==typeof Notification)return void console.warn("[SW] Browser tidak mendukung Notification API");const t=Notification.permission;if("denied"===t)return void console.warn("[SW] Notifikasi diblokir oleh user");if("default"===t)return void console.warn("[SW] User belum memberi izin notifikasi");let n="Story Well",i="Ada cerita baru!",o=`${BASE}icons/icon-192.png`,a=`${BASE}#/`,s="story";if(e.data)try{const t=e.data.json();n=t.title??n,i=t.body??i,o=t.icon??o,a=t.url??a,s=t.id?`story-${t.id}`:s}catch{i=await e.data.text()}try{return self.registration.showNotification(n,{body:i,icon:o,badge:`${BASE}icons/badge-72.png`,tag:s,data:{url:a},actions:[{action:"open",title:"Buka"},{action:"dismiss",title:"Tutup"}]})}catch(e){console.error("[SW] Gagal menampilkan notifikasi:",e)}})())}),self.addEventListener("sync",e=>{"sync-pending"===e.tag&&e.waitUntil(syncPending())});